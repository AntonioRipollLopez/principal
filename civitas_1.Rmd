---
title: "CIVITAS_1"
author: "Antonio Ripoll"
date: "13 de marzo de 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

## Carga de directorio y librerias

```{r}
# Mira en que ordenador trabaja y elige directorio
donde=Sys.info()["nodename"] 
if(donde['nodename']=="ANTONIOHP") setwd("C:/Users/Antonio/Google Drive/civitas") else setwd("C:/DADES/POUMTORRE_2/civitas")
library(RPostgreSQL)
library(maptools)
library(rgdal)
library(rgeos)
```

## CONEXION A SERVIDOR Y QUERY
Query y proceso en servidor 
```{r}
library(RPostgreSQL)
con <- dbConnect(PostgreSQL(), host="comundata.com", user= "postgres", password="pasipasi", dbname="opendata")
testdist='SELECT "PARCELA"."REFCAT",ST_AsText(ST_ExteriorRing("PARCELA".the_geom)) par, ST_AsText(construparcel3.geom) cons,
                ST_Distance(ST_AsText(ST_ExteriorRing("PARCELA".the_geom)),ST_AsText(construparcel3.geom)) dist,
                ST_AREA(ST_AsText(construparcel3.geom)) areacons,
                ST_Perimeter(ST_AsText(construparcel3.geom)) pericons,
                ST_AsText(ST_ShortestLine(ST_ExteriorRing("PARCELA".the_geom), construparcel3.geom)) separa
                FROM public.construparcel3, public."PARCELA"
                WHERE "PARCELA"."REFCAT" = construparcel3.refcat;'
distancia = dbGetQuery(con, testdist)

distancia[1,"separa"]   # Linea de separacion minima
kmlLine(distancia$separa, kmlfile = "separa.kml")

hist(distancia$dist,breaks=300)
which.max(distancia$st_length)
dbDisconnect(con)

```

## Proceso local
Lectura de elementos
```{r}
library(rgdal)
library(rgeos)

construc<-readOGR("C:/Users/Antonio/Google Drive/INFORMACION/43_155_UA_2015-09-25_SHF/CONSTRU","CONSTRUalto",
                  stringsAsFactors=FALSE) # en Tarragona
# construc<-readOGR("C:/DADES/DadesObertes/CLUSTER","CONSTRU_alto", stringsAsFactors=FALSE) # en Torredembarra

str(construc@data)
gArea(construc[1,])     # Area del primer elemento
gDistance(construc[1,],construc[2,])    # Distancia entre el primer y segundo elemento

manzana<-subset(construc,MASA==construc$MASA[1])
edif<-subset(construc,MASA==construc$MASA[1] & construc$plantas>0)      # construc con una o mas plantas
summary(manzana)
plot(manzana, col="red")
una<-gUnaryUnion(edif)  # Union de todas as construcciones
linea<-gBoundary(una)   # Perimetro de la construccion
summary(una)
plot(linea,col="white",add=TRUE)

```

Operaciones geometricas
```{r}
construc<-readOGR("C:/Users/Antonio/Google Drive/INFORMACION/43_155_UA_2015-09-25_SHF/CONSTRU","CONSTRUalto",
                  stringsAsFactors=FALSE) # en Tarragona
# construc<-readOGR("C:/DADES/DadesObertes/CLUSTER","CONSTRU_alto", stringsAsFactors=FALSE) # en Torredembarra
parcel <-gUnaryUnion(construc, as.character(construc$REFCAT))
construcmas1=subset(construc,plantas>0) # Construcciones con mas de una planta
unicons <- gUnaryUnion(construcmas1, as.character(construcmas1$REFCAT)) #Union de construcciones por referencia catastral

distedif=as.data.frame(row.names(parcel), stringsAsFactors = FALSE)
names(distedif)<-"refcat"
distedif$dista=0

for (i in seq(nrow(parcel))) {
        edif <- unicons[which(ID == parcel@polygons[[i]]@ID)]
        distedif[,"dista"] <- gDistance(gBoundary(parcel[i]),edif)
}

```


## Llamada a servidor y proceso local
Busqueda de la separacion minima a limites de parcela
```{r}
library(spatstat)
con <- dbConnect(PostgreSQL(), host="comundata.com", user= "postgres", password="pasipasi", dbname="opendata")
test='SELECT DISTINCT ON ("PARCELA".gid) "PARCELA".gid, ST_AsText("PARCELA".the_geom) par, ST_AsText(construparcel3.geom) constru,
        ST_AsText(ST_ShortestLine(ST_ExteriorRing("PARCELA".the_geom), construparcel3.geom)) separa,
        ST_Distance(ST_ExteriorRing("PARCELA".the_geom),construparcel3.geom) dista
        FROM public."PARCELA" INNER JOIN public.construparcel3 ON ("PARCELA"."REFCAT" = construparcel3.refcat);'        
#         FROM public."PARCELA", public.construparcel3
#         WHERE "PARCELA"."REFCAT" = construparcel3.refcat;'
parcel = dbGetQuery(con, test)
str(parcel)
gArea(readWKT(parcel[1,"par"]))
gArea(readWKT(parcel[1,"constru"]))
grafo <- readWKT(parcel[1,"separa"])

###############
str(parcel$gid)
row.names(parcel) = parcel$gid

# (Funcion muy lenta) 
for (i in seq(nrow(parcel))) {
  if (i == 1) {
    spTemp = readWKT(parcel$separa[i],parcel$gid[i])
  }
  else {
    spTemp = rbind(
      spTemp, readWKT(parcel$separa[i],parcel$gid[i])
    )
  }
print(i)
}

spdfFinal = SpatialLinesDataFrame(spTemp, parcel[-2])
plot(spdfFinal)
writeLinesShape(spdfFinal,"C:/Users/Antonio/Google Drive/INFORMACION/43_155_UA_2015-09-25_SHF/CONSTRU/CONSTRUsepPARCEL")

```


Busqueda de la separacion minima a fachada
```{r}
library(spatstat)
con <- dbConnect(PostgreSQL(), host="comundata.com", user= "postgres", password="pasipasi", dbname="opendata")
# dbListTables(con)
# dbListFields(con, "construparcel3")
test='SELECT DISTINCT ON (construparcel3.gid) construparcel3.gid, ST_AsText(masa.geom) masa, ST_AsText(construparcel3.geom) constru,
        ST_AsText(ST_ShortestLine(ST_ExteriorRing(masa.geom), construparcel3.geom)) separa,
        ST_Distance(ST_ExteriorRing(masa.geom),construparcel3.geom) dista
        FROM public.construparcel3 INNER JOIN public.masa ON (construparcel3.masa=masa.masa);'        
#         FROM public."PARCELA", public.construparcel3
#         WHERE "PARCELA"."REFCAT" = construparcel3.refcat;'
facha = dbGetQuery(con, test)
str(facha)
gArea(readWKT(facha[1,"par"]))
gArea(readWKT(facha[1,"constru"]))
grafo <- readWKT(facha[1,"separa"])

###############
str(facha$gid)
row.names(facha) = facha$gid

# (Funcion muy lenta) 
for (i in seq(nrow(facha))) {
  if (i == 1) {
    spTemp2 = readWKT(facha$separa[i],facha$gid[i])
    distancia=gLength(readWKT(facha$separa[i],facha$gid[i]))
  }
  else {
    spTemp2 = rbind(
      spTemp2, readWKT(facha$separa[i],facha$gid[i])
    )
        distancia=rbind(
                distancia,gLength(readWKT(facha$separa[i],facha$gid[i]))
        )
    
  }
print(i)
}
spdfFinal2 = SpatialLinesDataFrame(spTemp2, facha[-2])
dista=as.data.frame(distancia)
spdfFinal2$distfacha <- dista$V1
writeLinesShape(spdfFinal2,"C:/Users/Antonio/Google Drive/INFORMACION/43_155_UA_2015-09-25_SHF/CONSTRU/CONSTRUsepFACHA")

```

